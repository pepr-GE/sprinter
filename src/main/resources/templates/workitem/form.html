<!DOCTYPE html>
<html lang="cs"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<body>
<div layout:fragment="content">
    <div class="page-header">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a th:href="@{/projects}">Projekty</a></li>
                <li class="breadcrumb-item"><a th:href="@{/projects/{id}(id=${project.id})}" th:text="${project.name}">Projekt</a></li>
                <li class="breadcrumb-item active" th:text="${pageTitle}">Nová položka</li>
            </ol>
        </nav>
        <h1 class="h4 mb-0" th:text="${pageTitle}">Nová položka</h1>
    </div>

    <div class="container-fluid px-3">
        <div class="row justify-content-center">
            <div class="col-lg-9">
                <div class="card">
                    <div class="card-body">
                        <form th:action="${item != null} ? @{/items/{id}/edit(id=${item.id})} : @{/projects/{id}/items(id=${project.id})}"
                              method="post"
                              th:object="${workItemDto}">

                            <!-- Globální chyby -->
                            <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger">
                                <div th:each="err : ${#fields.globalErrors()}" th:text="${err}">Chyba</div>
                            </div>

                            <div class="row g-3">

                                <!-- Typ položky -->
                                <div class="col-md-3">
                                    <label for="type" class="form-label">Typ *</label>
                                    <select class="form-select" id="type" th:field="*{type}" required>
                                        <option value="">Vyberte typ</option>
                                        <option th:each="t : ${workItemTypes}"
                                                th:if="${t.visible or workItemDto.type == t}"
                                                th:value="${t.name()}"
                                                th:text="${t.displayName}"
                                                th:selected="${workItemDto.type == t}">Typ</option>
                                    </select>
                                    <div class="form-text text-danger" th:if="${#fields.hasErrors('type')}"
                                         th:errors="*{type}">Chyba</div>
                                </div>

                                <!-- Název -->
                                <div class="col-md-9">
                                    <label for="title" class="form-label">Název *</label>
                                    <input type="text" class="form-control" id="title" th:field="*{title}"
                                           placeholder="Stručný a výstižný název položky..."
                                           th:classappend="${#fields.hasErrors('title')} ? 'is-invalid' : ''"
                                           required/>
                                    <div class="invalid-feedback" th:errors="*{title}">Chyba</div>
                                </div>

                                <!-- Popis -->
                                <div class="col-12">
                                    <label for="description" class="form-label">Popis</label>
                                    <textarea class="form-control" id="description" th:field="*{description}"
                                              rows="8"
                                              placeholder="Detailní popis, kroky k reprodukci, akceptační kritéria..."></textarea>
                                </div>

                                <!-- Priorita -->
                                <div class="col-md-3">
                                    <label for="priority" class="form-label">Priorita</label>
                                    <select class="form-select" id="priority" th:field="*{priority}">
                                        <option th:each="p : ${priorities}"
                                                th:value="${p.name()}"
                                                th:text="${p.displayName}"
                                                th:selected="${workItemDto.priority == p}">Priorita</option>
                                    </select>
                                </div>

                                <!-- Přiřazeno -->
                                <div class="col-md-4">
                                    <label for="assigneeId" class="form-label">Přiřazeno</label>
                                    <select class="form-select" id="assigneeId" th:field="*{assigneeId}">
                                        <option value="">Nepřiřazeno</option>
                                        <option th:each="u : ${projectMembers}"
                                                th:value="${u.id}"
                                                th:text="${u.fullName}"
                                                th:selected="${workItemDto.assigneeId == u.id}">Uživatel</option>
                                    </select>
                                </div>

                                <!-- Story body -->
                                <div class="col-md-2">
                                    <label for="storyPoints" class="form-label">Story body</label>
                                    <input type="number" class="form-control" id="storyPoints"
                                           th:field="*{storyPoints}"
                                           min="0" max="999"
                                           placeholder=""/>
                                </div>

                                <!-- Sprint -->
                                <div class="col-md-3">
                                    <label for="sprintId" class="form-label">Sprint</label>
                                    <select class="form-select" id="sprintId" th:field="*{sprintId}">
                                        <option value="">Backlog</option>
                                        <option th:each="s : ${sprints}"
                                                th:value="${s.id}"
                                                th:text="${s.name}"
                                                th:if="${!s.terminal}"
                                                th:selected="${workItemDto.sprintId == s.id}">Sprint</option>
                                    </select>
                                </div>

                                <!-- Datum zahájení -->
                                <div class="col-md-3">
                                    <label for="startDate" class="form-label">Datum zahájení</label>
                                    <input type="date" class="form-control datepicker" id="startDate"
                                           th:field="*{startDate}"/>
                                </div>

                                <!-- Termín dokončení -->
                                <div class="col-md-3">
                                    <label for="dueDate" class="form-label">Termín dokončení</label>
                                    <input type="date" class="form-control datepicker" id="dueDate"
                                           th:field="*{dueDate}"/>
                                </div>

                                <!-- Odhad hodin -->
                                <div class="col-md-2">
                                    <label for="estimatedHours" class="form-label">Odhad (h)</label>
                                    <input type="number" class="form-control" id="estimatedHours"
                                           th:field="*{estimatedHours}"
                                           min="0" step="0.5"
                                           placeholder="0"/>
                                </div>

                                <!-- Procento dokončení -->
                                <div class="col-md-4">
                                    <label for="progressPct" class="form-label">
                                        Dokončeno: <span id="progressPctVal" th:text="${workItemDto.progressPct} + '%'">0%</span>
                                    </label>
                                    <input type="range" class="form-range" id="progressPct"
                                           th:field="*{progressPct}"
                                           min="0" max="100" step="5"
                                           oninput="document.getElementById('progressPctVal').textContent = this.value + '%'"/>
                                </div>

                                <!-- Štítky -->
                                <div class="col-md-4">
                                    <label class="form-label">Štítky</label>
                                    <div class="label-selector">
                                        <div th:each="label : ${labels}" class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox"
                                                   th:id="${'label-' + label.id}"
                                                   name="labelIds"
                                                   th:value="${label.id}"
                                                   th:checked="${workItemDto.labelIds.contains(label.id)}"/>
                                            <label class="form-check-label label-chip"
                                                   th:for="${'label-' + label.id}"
                                                   th:style="${'background: ' + label.color + '22; color: ' + label.color}"
                                                   th:text="${label.name}">Label</label>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- Navázané dokumenty -->
                            <div class="mt-3 pt-3 border-top">
                                <label class="form-label">Navázané dokumenty</label>
                                <div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                            data-bs-toggle="modal" data-bs-target="#formLinkDocModal">
                                        <i class="bi bi-file-earmark-plus me-1"></i>Připojit dokument
                                    </button>
                                </div>
                                <!-- Hidden inputs – initial state from linkedDocuments (edit mode) -->
                                <div id="formDocInputs">
                                    <span th:each="doc : ${linkedDocuments}"
                                          th:attr="data-doc-id=${doc.id},data-doc-title=${doc.title}">
                                        <input type="hidden" name="docIds" th:value="${doc.id}"/>
                                    </span>
                                </div>
                                <!-- Chips of selected docs -->
                                <div id="formDocChips" class="d-flex flex-wrap gap-1 mt-2">
                                    <span th:each="doc : ${linkedDocuments}"
                                          class="badge bg-light text-dark border d-flex align-items-center gap-1"
                                          th:attr="data-doc-id=${doc.id}">
                                        <i class="bi bi-file-earmark-text"></i>
                                        <span th:text="${doc.title}">Dokument</span>
                                        <button type="button" class="btn-close ms-1"
                                                style="font-size:0.6rem;"
                                                th:attr="data-doc-id=${doc.id}"
                                                onclick="removeFormDoc(parseInt(this.dataset.docId))"></button>
                                    </span>
                                </div>
                            </div>

                            <!-- Akční tlačítka -->
                            <div class="d-flex gap-2 mt-4 pt-3 border-top">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-lg me-1"></i>
                                    <span th:text="${item != null ? 'Uložit změny' : 'Vytvořit položku'}">Uložit</span>
                                </button>
                                <a th:href="${item != null} ? @{/items/{id}(id=${item.id})} : @{/projects/{id}/backlog(id=${project.id})}"
                                   class="btn btn-outline-secondary">
                                    Zrušit
                                </a>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Připojit dokument (formulář) -->
    <div class="modal fade" id="formLinkDocModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-file-earmark-plus me-2"></i>Připojit dokument</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="row g-0" style="min-height: 350px;">
                        <!-- Levý panel: seznam dokumentů -->
                        <div class="col-lg-9 border-end d-flex flex-column">
                            <div class="p-3 border-bottom">
                                <input type="text" id="formDocSearch" class="form-control form-control-sm"
                                       placeholder="Hledat dokumenty podle názvu…"
                                       oninput="filterFormDocs()"/>
                            </div>
                            <div class="overflow-auto p-3 flex-grow-1" style="max-height: 380px;">
                                <div id="formDocModalList">
                                    <div th:each="doc : ${allDocuments}"
                                         class="form-doc-modal-row d-flex align-items-center gap-2 p-2 rounded mb-1"
                                         th:attr="data-doc-id=${doc.id},data-folder-id=${doc.folder != null ? doc.folder.id : 0},data-doc-title=${doc.title}"
                                         style="cursor:pointer;"
                                         onclick="toggleFormDoc(parseInt(this.dataset.docId))">
                                        <input type="checkbox" class="form-check-input flex-shrink-0 mt-0"
                                               th:id="'form-doc-' + ${doc.id}"
                                               th:checked="${linkedDocumentIds != null and linkedDocumentIds.contains(doc.id)}"
                                               onclick="event.stopPropagation();"/>
                                        <i class="bi bi-file-earmark-text text-muted flex-shrink-0"></i>
                                        <span class="flex-grow-1 small" th:text="${doc.title}">Dokument</span>
                                        <span th:if="${doc.folder != null}"
                                              class="text-muted small badge bg-light text-dark"
                                              th:text="${doc.folder.name}"></span>
                                    </div>
                                    <div id="formDocEmpty" class="text-muted small text-center py-3" style="display:none;">
                                        Žádné dokumenty odpovídají filtru
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Pravý panel: filtr složek -->
                        <div class="col-lg-3">
                            <div class="p-3">
                                <h6 class="small text-uppercase text-muted mb-2">Složky</h6>
                                <div class="folder-tree">
                                    <a href="#" class="folder-tree-item folder-tree-root active"
                                       onclick="filterFormByFolder(null, event)">
                                        <i class="bi bi-house me-1"></i>Vše
                                    </a>
                                    <div th:each="fo : ${allFolders}">
                                        <a href="#" class="folder-tree-item"
                                           th:attr="data-folder-id=${fo.id}"
                                           onclick="filterFormByFolder(parseInt(this.dataset.folderId), event)"
                                           th:text="${fo.displayName()}">Složka</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Zavřít</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="confirmFormDocSelection()">
                        <i class="bi bi-check-lg me-1"></i>Přidat vybrané
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ---- Form page: document linking modal ----
    let formSelectedFolderId = null;

    function filterFormDocs() {
        const term = document.getElementById('formDocSearch').value.toLowerCase();
        let visible = 0;
        document.querySelectorAll('#formDocModalList .form-doc-modal-row').forEach(row => {
            const title  = (row.dataset.docTitle || '').toLowerCase();
            const folder = row.dataset.folderId || '';
            const matchTitle  = title.includes(term);
            const matchFolder = formSelectedFolderId === null || folder == formSelectedFolderId;
            const show = matchTitle && matchFolder;
            row.style.display = show ? '' : 'none';
            if (show) visible++;
        });
        document.getElementById('formDocEmpty').style.display = visible === 0 ? '' : 'none';
    }

    function filterFormByFolder(folderId, event) {
        event.preventDefault();
        formSelectedFolderId = folderId;
        document.querySelectorAll('#formLinkDocModal .folder-tree-item').forEach(a => a.classList.remove('active'));
        event.currentTarget.classList.add('active');
        filterFormDocs();
    }

    function toggleFormDoc(docId) {
        const cb = document.getElementById('form-doc-' + docId);
        if (cb) cb.checked = !cb.checked;
    }

    function confirmFormDocSelection() {
        const inputs  = document.getElementById('formDocInputs');
        const chips   = document.getElementById('formDocChips');

        // Collect current selections from modal checkboxes
        const selected = new Map();
        document.querySelectorAll('#formDocModalList .form-doc-modal-row').forEach(row => {
            const cb = row.querySelector('input[type=checkbox]');
            if (cb && cb.checked) {
                selected.set(parseInt(row.dataset.docId), row.dataset.docTitle);
            }
        });

        // Rebuild hidden inputs
        inputs.innerHTML = '';
        selected.forEach((title, docId) => {
            const inp = document.createElement('input');
            inp.type = 'hidden'; inp.name = 'docIds'; inp.value = docId;
            inputs.appendChild(inp);
        });

        // Rebuild chips
        chips.innerHTML = '';
        selected.forEach((title, docId) => {
            const chip = document.createElement('span');
            chip.className = 'badge bg-light text-dark border d-flex align-items-center gap-1';
            chip.dataset.docId = docId;
            chip.innerHTML = `<i class="bi bi-file-earmark-text"></i><span>${title}</span>` +
                `<button type="button" class="btn-close ms-1" style="font-size:0.6rem;" onclick="removeFormDoc(${docId})"></button>`;
            chips.appendChild(chip);
        });

        bootstrap.Modal.getInstance(document.getElementById('formLinkDocModal')).hide();
    }

    function removeFormDoc(docId) {
        // Uncheck in modal
        const cb = document.getElementById('form-doc-' + docId);
        if (cb) cb.checked = false;
        // Remove hidden input
        document.querySelectorAll('#formDocInputs input').forEach(inp => {
            if (parseInt(inp.value) === docId) inp.remove();
        });
        // Remove chip
        document.querySelectorAll('#formDocChips [data-doc-id]').forEach(chip => {
            if (parseInt(chip.dataset.docId) === docId) chip.remove();
        });
    }

    // Sync modal checkboxes when modal opens (to reflect any external state)
    document.getElementById('formLinkDocModal').addEventListener('show.bs.modal', function() {
        const currentIds = new Set(
            Array.from(document.querySelectorAll('#formDocInputs input')).map(i => parseInt(i.value))
        );
        document.querySelectorAll('#formDocModalList .form-doc-modal-row').forEach(row => {
            const cb = row.querySelector('input[type=checkbox]');
            if (cb) cb.checked = currentIds.has(parseInt(row.dataset.docId));
        });
        // Reset search and folder filter
        document.getElementById('formDocSearch').value = '';
        formSelectedFolderId = null;
        document.querySelectorAll('#formLinkDocModal .folder-tree-item').forEach(a => a.classList.remove('active'));
        const root = document.querySelector('#formLinkDocModal .folder-tree-root');
        if (root) root.classList.add('active');
        filterFormDocs();
    });
    </script>

</div>
</body>
</html>
